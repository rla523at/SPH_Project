# 4주차

## Solver 개선
$\nu = 1.0e-6$과 density clamp 없이 정상동작하더라도 물보다 너무 점성이 큰 액체처럼 거동

![2024-07-23 10 29 33 mass 개선](https://github.com/user-attachments/assets/8b7f3e93-5ef7-4c63-93ac-3c649db72902)

## Smoothing Length 개선

particle의 initial distance를 $\Delta x$라고 할 때, 기존의 논문들은 smoothing length($h$)를 $h = 1.0 \Delta x \sim 2.0\Delta x$를 사용.

기존에는 $h=0.6 \Delta x$를 사용 중이여서 이를 기존 논문들의 값과 비슷한 값을 사용하게 개선

### 문제점

$h=1.1\Delta x$로 증가시키면, 



$$  $$



<br><br><br>

# 3주차
## Solver 개선

### Motivation
기존의 simulation이 물보다 너무 점성이 큰 액체처럼 거동
![2024-07-16 11 10 29](https://github.com/user-attachments/assets/b3ca0729-112b-42fd-94a9-70095319341b)

$$ \frac{dv}{dt} = - \frac{1}{\rho}\nabla p + \nu \nabla^2 v + \frac{f_{ext}}{m} $$

동점성 계수 $\nu = 1.0e-3$을 사용하고 있었는데, 이를 실제 물의 계수인 $1.0e-6$에 가깝게 줄이는 과정에서 simulation이 발산하는 문제가 발생.

solver 자체의 문제가 있다고 판단.

### Density 문제
현재 밀도는 압력이 음수가 되지 않게, 그리고 비압축성 가정을 만족하게 제한 되어 있음.

$$ \rho_0 \le \rho \le 1.01 \rho_0 $$

```cpp
cur_rho = std::clamp(cur_rho, rho0, 1.01f * rho0);
```

기존 논문들에는 없는 제약조건이 왜 필요한지 파악 후 개선하기 위해 clamp를 제거후 문제상황을 분석.

![2024-07-23 10 10 49 mass mongham + boundary](https://github.com/user-attachments/assets/2cc5c05a-5131-44a7-9e5a-25ad5021bcef)

#### Density 계산 및 Boundary Interaction
물리적으로, 물은 $\rho_0 = 1000$이라는 rest density를 가져야 한다.

하지만 partic들의 $\rho$를 계산하면 450 ~ 460의 값을 갖게 되어 particle들이 순간적으로 매우 강하게 압축되고, 이로 인해 거리가 가까워지면 $\rho$값이 순간적으로 폭발적으로 증가하여 다시 아주 강하게 팽창시키는 힘이 만들어진다.

SPH descritization에서 $x$ 위치에서 밀도는 다음과 같다.

$$ \rho(x) =  \sum_j m_j W(x,x_j,h) $$

이 때, 일반적으로 $m_j$는 particle마다 전부 동일하다는 가정으로 상수값으로 두어 식을 다음과 같이 단순화한다.

$$ \rho(x) = m \sum_j  W(x,x_j,h) $$

즉, $\rho$는 결국 $m$과 $W$에 의해 결정된다.

**[Density 계산 해결]**

다양한 논문을 통해 비교 검증한 결과 kernel 함수 $W$에서는 문제점을 발견하지 못했고, $m$ 계산 방식을 수정

1994 (monaghan) Simulating Free Surface Flows with SPH

$$ m = \rho_0 \frac{V}{N_{particle}} $$

2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

$$ m = \frac{\rho_0}{\max(\{ \sum_j W(x,x_j,h) \})} $$ 

참고로, $W$ 함수의 성질에 의해 $\sum_j W(x,x_j,h)$ 값은 $x$ 위치에서의 particle의 number density(밀집정도)를 나타내는 값이 된다.

즉, 2012 (Mostafa et al)의 방식은 가장 밀집된 곳에 있는 particle의 밀도가 $\rho_0$가 되게끔 결정하는 방식이다.

**[Boundary Interaction]**

추가적으로, $z=0$ 위치에 있는 particle들이 움직이는 과정에서 $z=0$ boundary와 상호작용이 발생한다.

상호작용이 발생하게 되면 순간적으로 위치와 속도가 조정이 되고 이 영향으로 폭발적으로 팽창하게 되는 문제가 있어, 문제의 초기 조건을 수정하였다.

**[개선결과]**

![2024-07-19 10 33 06](https://github.com/user-attachments/assets/5c27710d-effe-44aa-8c26-651900078a2f)


**[추가 개선]**

질량 계산 방식을 개선한 후에도 partic들의 $\rho$를 계산하면 973, 982, 991, 1000의 4가지 값을 갖게 된다. 

이 떄, 1000보다 작은 밀도를 갖는 particle들이 압축시키는 힘을 만들어내고, 이로 인해 거리가 가까워지면 $\rho$값이 증가하여 다시 팽창시키는 힘이 만들어진다.

이 과정을 통해 압축 팽창이 반복되게 된다.

따라서, 이를 개선하기 위해, 밀도 불균형을 가능한 해결하려고 $m$ 계산 방식을 다음과 같이 개선하였다.

$$ m = \frac{\rho_0}{\text{avg}(\{ \sum_j W(x,x_j,h) \})} $$ 

이 수식의 경우, 평균적인 밀집정도를 갖는 곳에 있는 particle의 밀도가 $\rho_0$가 되게끔 결정하게 되어 density fluctuation $\frac{|\rho-\rho_0|}{\rho_0}$을 줄일 수 있다.

그 결과 압축 팽창 정도를 많이 줄일 수 있었다.

![2024-07-19 11 27 20 avg](https://github.com/user-attachments/assets/23b824c3-40ff-4d7b-9c4b-ca2d41a771cf)


**[최종 개선 결과]**

$\nu = 1.0e-6$과 density clamp 없이 정상동작

![2024-07-23 10 29 33 mass 개선](https://github.com/user-attachments/assets/8b7f3e93-5ef7-4c63-93ac-3c649db72902)

### Numerical Integration 개선시도

비압축성 유체의 지배방정식에 SPH descritization을 적용하면, 결론적으로 다음 연립미분방정식을 풀게 된다.

$$ \begin{aligned}
\frac{dv}{dt} &= f(v,x) \\
\frac{dx}{dt} &= v  
\end{aligned} $$

논문을 통해, explicit scheme 중 semi implicit euler과 leap frog 방법이 가장 많이 사용됨을 확인하고 두 scheme을 구현하여 dt를 바꿔가며 stability를 비교하였다.

**[semi implicit euler]**

$$ \begin{aligned}
\frac{v^{n+1} - v^{n}}{\Delta t} &= f(v^n,x^n) \\
\frac{x^{n+1} - x^{n}}{\Delta t} &= v^{n+1}  
\end{aligned} $$

**[leap frog - KDK]**

$$ \begin{aligned}
\frac{v^{n+1/2} - v^{n}}{0.5 \Delta t} &= f(v^n,x^n)\\
\frac{x^{n+1} - x^{n}}{\Delta t} &= v^{n+1/2}  \\
\frac{v^{n+1} - v^{n+1/2}}{0.5 \Delta t} &= f(v^{n+1/2},x^{n+1})\\
\end{aligned} $$

**[leap frog - DKD]**

$$ \begin{aligned}
\frac{x^{n+1/2} - x^{n}}{0.5 \Delta t} &= v^{n}  \\
\frac{v^{n+1} - v^{n}}{\Delta t} &= f(v^n,x^{n+1/2})\\
\frac{x^{n+1} - x^{n+1/2}}{0.5 \Delta t} &= v^{n+1}  \\
\end{aligned} $$

**[결론]**

$\Delta t$를 $1.0e-4$ 단위로 바꿔가면서 test 해본 결과 둘의 stability는 유의미하게 차이가 나지 않았다.

계산 algorithm이 단순하여 가장 성능이 좋은 semi implicit euler scheme을 사용하기로 결정하였다.



### 추가 개선점

**[Surface Tension 구현]**

Surface Tension을 추가로 구현하여, Zero gravity droplet 테스트를 진행

![droplet](https://github.com/user-attachments/assets/916e7bde-b7af-44fa-a85b-14ad4638114c)

구형을 유지해야 하지만 계속해서 팽창해 나가는 문제가 발생

![2024-07-23 11 02 12 Surface Tension (2)](https://github.com/user-attachments/assets/47a707ef-1d7c-4196-af91-d6efab1e3532)


**[Boundary Particle 구현]**

현재는, boundary처리를 다음과 같은 간단한 수식으로 처리 중.

```cpp
     auto& v_pos = _fluid_position_vectors[i];
     auto& v_vel = _fluid_velocity_vectors[i];

     //left wall
     if (v_pos.x < wall_x_start && v_vel.x < 0.0f)
     {
       v_vel.x *= -cor2;
       v_pos.x = wall_x_start;
     }
     //...
```

이런 boundary condition 때문에, 점성이 강해보일 수 있다고 판단해 boundary particle 도입 시도.

boundary particle $k$가 fluid particle $a$에게 주는 영향은 다음과 같이 계산 됨.

$$ f_{ak} = \frac{m_k}{m_a+m_k} B(x,y) n_k $$

$$ B(x,y) = \Gamma(y) = 0.02 \frac{(v_s)^2}{y}  \begin{cases} \frac{2}{3} \\ 2q - 1.5q^2 \\ 0.5(2-q)^2 \end{cases} $$

$x$는 boundary tangential 거리 $y$는 boundary normal 거리이며, $q=y/h$, $v_s$는 가상의 음속이다.

이를 구현하였지만, 진동 문제가 발생함

![2024-07-23 09 57 13 boundary particle problem](https://github.com/user-attachments/assets/34fded04-116b-4549-87ad-8f05d9beb68d)

시간에 따른 거리 속도 가속도 그래프를 그려보니, 수렴하지 않고 일정한 진폭을 갖는 모습을 보임.

![boundary particel SVA](https://github.com/user-attachments/assets/b473b8ad-8c68-49aa-9d23-af2f6fd3e2a9)

주황색 - 거리, 회색 - 속도, 노란색 - 가속도

액체가 탄성을 갖는 공도 아닌데, 진동하면서 수렴해가는 거동을 하는 것도 이상하고,

velocity ~ 0과 acceleartion ~ 0 을 동시에 맞추는게 상당히 어려울 것 같음.

</br></br></br>