# 3주차
## Solver 개선

### Motivation
기존의 simulation이 물보다 너무 점성이 큰 액체처럼 거동
![2024-07-16 11 10 29](https://github.com/user-attachments/assets/b3ca0729-112b-42fd-94a9-70095319341b)

$$ \frac{dv}{dt} = - \frac{1}{\rho}\nabla p + \nu \nabla^2 v + \frac{f_{ext}}{m} $$

동점성 계수 $\nu = 1.0e-3$을 사용하고 있었는데, 이를 실제 물의 계수인 $1.0e-6$에 가깝게 줄이는 과정에서 simulation이 발산하는 문제가 발생.

solver 자체의 문제가 있다고 판단.

### Density 문제
현재 밀도는 압력이 음수가 되지 않게, 그리고 비압축성 가정을 만족하게 제한 되어 있음.

$$ \rho_0 \le \rho \le 1.01 \rho_0 $$

```cpp
cur_rho = std::clamp(cur_rho, rho0, 1.01f * rho0);
```

기존 논문들에는 없는 제약조건이 왜 필요한지 파악 후 개선하기 위해 clamp를 제거후 문제상황을 분석.

![2024-07-23 10 10 49 mass mongham + boundary](https://github.com/user-attachments/assets/2cc5c05a-5131-44a7-9e5a-25ad5021bcef)

#### Density 계산 및 Boundary Interaction
물리적으로, 물은 $\rho_0 = 1000$이라는 rest density를 가져야 한다.

하지만 partic들의 $\rho$를 계산하면 450 ~ 460의 값을 갖게 되어 particle들이 순간적으로 매우 강하게 압축되고, 이로 인해 거리가 가까워지면 $\rho$값이 순간적으로 폭발적으로 증가하여 다시 아주 강하게 팽창시키는 힘이 만들어진다.

SPH descritization에서 $x$ 위치에서 밀도는 다음과 같다.

$$ \rho(x) =  \sum_j m_j W(x,x_j,h) $$

이 때, 일반적으로 $m_j$는 particle마다 전부 동일하다는 가정으로 상수값으로 두어 식을 다음과 같이 단순화한다.

$$ \rho(x) = m \sum_j  W(x,x_j,h) $$

즉, $\rho$는 결국 $m$과 $W$에 의해 결정된다.

**[Density 계산 해결]**

다양한 논문을 통해 비교 검증한 결과 kernel 함수 $W$에서는 문제점을 발견하지 못했고, $m$ 계산 방식을 수정

1994 (monaghan) Simulating Free Surface Flows with SPH

$$ m = \rho_0 \frac{V}{N_{particle}} $$

2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

$$ m = \frac{\rho_0}{\max(\{ \sum_j W(x,x_j,h) \})} $$ 

참고로, $W$ 함수의 성질에 의해 $\sum_j W(x,x_j,h)$ 값은 $x$ 위치에서의 particle의 number density(밀집정도)를 나타내는 값이 된다.

즉, 2012 (Mostafa et al)의 방식은 가장 밀집된 곳에 있는 particle의 밀도가 $\rho_0$가 되게끔 결정하는 방식이다.

**[Boundary Interaction]**

추가적으로, $z=0$ 위치에 있는 particle들이 움직이는 과정에서 $z=0$ boundary와 상호작용이 발생한다.

상호작용이 발생하게 되면 순간적으로 위치와 속도가 조정이 되고 이 영향으로 폭발적으로 팽창하게 되는 문제가 있어, 문제의 초기 조건을 수정하였다.

**[개선결과]**

![2024-07-19 10 33 06](https://github.com/user-attachments/assets/5c27710d-effe-44aa-8c26-651900078a2f)


**[추가 개선]**

질량 계산 방식을 개선한 후에도 partic들의 $\rho$를 계산하면 973, 982, 991, 1000의 4가지 값을 갖게 된다. 

이 떄, 1000보다 작은 밀도를 갖는 particle들이 압축시키는 힘을 만들어내고, 이로 인해 거리가 가까워지면 $\rho$값이 증가하여 다시 팽창시키는 힘이 만들어진다.

이 과정을 통해 압축 팽창이 반복되게 된다.

따라서, 이를 개선하기 위해, 밀도 불균형을 가능한 해결하려고 $m$ 계산 방식을 다음과 같이 개선하였다.

$$ m = \frac{\rho_0}{\text{avg}(\{ \sum_j W(x,x_j,h) \})} $$ 

이 수식의 경우, 평균적인 밀집정도를 갖는 곳에 있는 particle의 밀도가 $\rho_0$가 되게끔 결정하게 되어 density fluctuation $\frac{|\rho-\rho_0|}{\rho_0}$을 줄일 수 있다.

그 결과 압축 팽창 정도를 많이 줄일 수 있었다.

![2024-07-19 11 27 20 avg](https://github.com/user-attachments/assets/23b824c3-40ff-4d7b-9c4b-ca2d41a771cf)


**[최종 개선 결과]**

$\nu = 1.0e-6$과 density clamp 없이 정상동작

![2024-07-23 10 29 33 mass 개선](https://github.com/user-attachments/assets/8b7f3e93-5ef7-4c63-93ac-3c649db72902)

### Numerical Integration 개선시도

비압축성 유체의 지배방정식에 SPH descritization을 적용하면, 결론적으로 다음 연립미분방정식을 풀게 된다.

$$ \begin{aligned}
\frac{dv}{dt} &= f(v,x) \\
\frac{dx}{dt} &= v  
\end{aligned} $$

논문을 통해, explicit scheme 중 semi implicit euler과 leap frog 방법이 가장 많이 사용됨을 확인하고 두 scheme을 구현하여 dt를 바꿔가며 stability를 비교하였다.

**[semi implicit euler]**

$$ \begin{aligned}
\frac{v^{n+1} - v^{n}}{\Delta t} &= f(v^n,x^n) \\
\frac{x^{n+1} - x^{n}}{\Delta t} &= v^{n+1}  
\end{aligned} $$

**[leap frog - KDK]**

$$ \begin{aligned}
\frac{v^{n+1/2} - v^{n}}{0.5 \Delta t} &= f(v^n,x^n)\\
\frac{x^{n+1} - x^{n}}{\Delta t} &= v^{n+1/2}  \\
\frac{v^{n+1} - v^{n+1/2}}{0.5 \Delta t} &= f(v^{n+1/2},x^{n+1})\\
\end{aligned} $$

**[leap frog - DKD]**

$$ \begin{aligned}
\frac{x^{n+1/2} - x^{n}}{0.5 \Delta t} &= v^{n}  \\
\frac{v^{n+1} - v^{n}}{\Delta t} &= f(v^n,x^{n+1/2})\\
\frac{x^{n+1} - x^{n+1/2}}{0.5 \Delta t} &= v^{n+1}  \\
\end{aligned} $$

**[결론]**

$\Delta t$를 $1.0e-4$ 단위로 바꿔가면서 test 해본 결과 둘의 stability는 유의미하게 차이가 나지 않았다.

계산 algorithm이 단순하여 가장 성능이 좋은 semi implicit euler scheme을 사용하기로 결정하였다.



### 추가 개선점

**[Surface Tension 구현]**

Surface Tension을 추가로 구현하여, Zero gravity droplet 테스트를 진행

![droplet](https://github.com/user-attachments/assets/916e7bde-b7af-44fa-a85b-14ad4638114c)

구형을 유지해야 하지만 계속해서 팽창해 나가는 문제가 발생

![2024-07-23 11 02 12 Surface Tension (2)](https://github.com/user-attachments/assets/47a707ef-1d7c-4196-af91-d6efab1e3532)


**[Boundary Particle 구현]**

현재는, boundary처리를 다음과 같은 간단한 수식으로 처리 중.

```cpp
     auto& v_pos = _fluid_position_vectors[i];
     auto& v_vel = _fluid_velocity_vectors[i];

     //left wall
     if (v_pos.x < wall_x_start && v_vel.x < 0.0f)
     {
       v_vel.x *= -cor2;
       v_pos.x = wall_x_start;
     }
     //...
```

이런 boundary condition 때문에, 점성이 강해보일 수 있다고 판단해 boundary particle 도입 시도.

boundary particle $k$가 fluid particle $a$에게 주는 영향은 다음과 같이 계산 됨.

$$ f_{ak} = \frac{m_k}{m_a+m_k} B(x,y) n_k $$

$$ B(x,y) = \Gamma(y) = 0.02 \frac{(v_s)^2}{y}  \begin{cases} \frac{2}{3} \\ 2q - 1.5q^2 \\ 0.5(2-q)^2 \end{cases} $$

$x$는 boundary tangential 거리 $y$는 boundary normal 거리이며, $q=y/h$, $v_s$는 가상의 음속이다.

이를 구현하였지만, 진동 문제가 발생함

![2024-07-23 09 57 13 boundary particle problem](https://github.com/user-attachments/assets/34fded04-116b-4549-87ad-8f05d9beb68d)

시간에 따른 거리 속도 가속도 그래프를 그려보니, 수렴하지 않고 일정한 진폭을 갖는 모습을 보임.

![boundary particel SVA](https://github.com/user-attachments/assets/b473b8ad-8c68-49aa-9d23-af2f6fd3e2a9)

주황색 - 거리, 회색 - 속도, 노란색 - 가속도

액체가 탄성을 갖는 공도 아닌데, 진동하면서 수렴해가는 거동을 하는 것도 이상하고,

velocity ~ 0과 acceleartion ~ 0 을 동시에 맞추는게 상당히 어려울 것 같음.

</br></br></br>

# SPH Frame Work
SPH approximation에 의해 임의의 물리량 $f$에 대한 근사식은 다음과 같다.

$$ f(x) = \sum_j \frac{m_j}{\rho_j}f(x_j) W(x-x_j,h) $$

이 approximation을 통해 비압축성 유체의 linear momentum equation을 푼다.

$$ \frac{du}{dt} = -\frac{1}{\rho}\nabla p + \nu \nabla^2u + f_{ext} $$

전체적인 solution prcess는 다음과 같다.

1. SPH approximation을 통해 $\rho$를 계산한다.
2. 계산된 $\rho$를 통해 $p$를 계산한다.
3. SPH approximation를 활용해 linear momentum equation의 RHS를 계산한다.
4. 계산된 가속도로 속도를 업데이트하고, 속도로 위치를 업데이트한다.

</br></br>

# SPH Approximation
## Integral Representation
임의의 $f:\mathbb{R}^3\rightarrow \mathbb{R}$가 있을 떄, 임의의 $x \in \Omega \subseteq \mathbb{R}^3$에 대해서 다음이 성립한다.

$$ f(x) = \int_{\Omega} f(t)\delta(x-t)dt $$

$\delta$는 dirac-delta function kernel이다.

## Approximation of Integral Representation
$\delta$를 임의의 smooth kernel function $W(x,h):\mathbb{R}^3 \rightarrow \mathbb{R}$로 근사하면 다음과 같다.

$$ f(x) \approx \int_{\Omega} f(t)W(x-t, h)dt $$

이처럼, $\delta$를 임의의 smooth function으로 approximation을 하기 때문에 'smoothed' particle hydronamics라고 한다.

## Particle Approximation
$W$를 이용한 Integral Representation의 approximation은 discretized form으로 한번 더 근사가 될 수 있다.

$$ \begin{aligned} 
f(x) &\approx \int_{\Omega} f(t)W(x-t, h)dt \\ 
     &\approx \sum_{j} f(x_j)W(x-x_j,h) \Delta V_j \\ 
     & = \sum_{j} f(x_j)W(x-x_j,h) \frac{\rho_j \Delta V_j}{\rho_j} \\ 
     &= \sum_{j} f(x_j)W(x-x_j,h) \frac{m_j}{\rho_j} 
\end{aligned}  $$

따라서, SPH frame work상 임의의 물리량 $f$에 대한 최종 근사식은 다음과 같다.

$$ f(x) = \sum_j \frac{m_j}{\rho_j}f(x_j) W(x-x_j,h) $$

</br></br>

# Smooth Kernel Function
$W(x,h)$는 $\delta$를 근사한 함수이기 때문에 다음 세가지 조건을 만족해야한다.

Normalization condition

$$ \int_\Omega W(x-t,h)dt = 1$$

Delta Function Property

$$ \lim_{h\rightarrow 0} W(x-t,h) = \delta(x-t)$$

Compact Supprot Property

$$ \kappa h < |x-t| \implies W(x-t,h) = 0 $$

따라서, $h$에 의해 $W$의 compact support domain이 결정되며, $h$를 support length라고 한다.

![support length](https://github.com/user-attachments/assets/788aa774-2b4f-4b4c-a260-6a9b29e40c33)

</br></br>

# Density Calculation
SPH 근사식에 밀도를 대입하면 다음과 같다.

$$ \rho(x) = \sum_j m_jW(x,x_j,h) $$

비압축성 유체이기 때문에 $m_j$가 일정하다고 가정하면 밀도는 오직 거리의 함수이다. 

밀도는 pressure calculation과 비압축성 가정 $(\frac{\Delta\rho}{\rho_0})^2 \sim (M \le 0.1)$에 의해 다음 범위의 값을 갖는것이 타당하다.

$$ \rho_0 \le \rho \le 1.01 \rho_0 $$

밀도 값에 영향을 주는 값들은 $m$ 그리고 $W$ 값이다.

이 때, $W$의 값은 $h$를 어떻게 결정하냐에 따라 크게 달라진다.

## smoothing length
3차원 기준 neighbor가 50개가 되도록 잡는게 좋다.

> Reference  
> https://scicomp.stackexchange.com/questions/16363/how-to-choose-h-in-sph  

</br></br>

# Pressure Calculation
압력은 Equation of state에 기반하여 수정한 다음 식을 사용한다.

$$ p = k ((\frac{\rho}{\rho_0})^7 - 1) $$

$\rho_0$는 rest density로 유체가 기본 상태에 있을 때의 밀도를 나타낸다.

$k$는 stiffness constant로 큰 값을 쓸 수록, compressibility는 줄어들지만 (밀도 변화는 줄어들지만) time step 또한 줄어든다.

참고로, 위 식에서 $\rho < \rho_0$인 경우 $p<0$가 된다. 압력이 음수가 되는 것은 비물리적임으로 밀도가 $\rho_0$ 항상 커야 한다.

</br></br>

# Acceleration by Pressure

$$ a_p(x_i) = - \frac{1}{\rho} \sum_j m_j(\frac{p_a}{\rho_a^2} + \frac{p_b}{\rho_b^2}) \nabla_iW_{ij} $$

$a_p$의 방향은 $-\nabla_iW_{ij}$이다.

</br></br>

---

* SPH Water simulation 
  * https://www.youtube.com/watch?v=uaoT37-NhCE
  * https://www.youtube.com/watch?v=7kDVjZkc_TI
  * https://www.youtube.com/watch?v=9YxseonuAJ8 (droplet)


* Weakly Compressible SPH (WCSPH)
  * local pressure solvers
* Incompressible SPH (ISPH)
  * global pressure solvers


# Smoothing Length
* $h=1.3 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 1999 (Sharen and Rudman) An SPH Projection Method

* $h = 1 - 1.5 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2000 (Joseph) Simulating surface tension with SPH
  * 

* $h = \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows

* $h = 1.6 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# mass
* normalized mass
  * [note] 2011 (cornell)  

* density * particle volume
  * 1994 (monaghan) Simulating Free Surface Flows with SPH - 5. Implementation

* number density
  * 2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# Kernel Function
* cubic spline 
* 2014 (Markus et al) SPH Fluids in Computer Graphics
* 2010 (Liu and Liu) SPH an overview and recent developments
* gradient, dwdq
  * https://pysph.readthedocs.io/en/latest/_modules/pysph/base/kernels.html#CubicSpline.gradient_h

# Density Calculation
* evolve particel density
  * 1994 (monaghan) Simulating Free Surface Flows with SPH
  * 

* Free Surface Boundaries
  * 2012 (Xiaowei et al) Local Poisson SPH For Viscous Incompressible Fluids


# Pressure Calculation
* Tait's equation
  * $B = \rho_0 V_s^2 / \gamma$ ~ 1.1e06 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows
    * 2012 (Xiaowei et al) Local Poisson SPH For Viscous Incompressible Fluids
  * K = 2.15GPa https://en.wikipedia.org/wiki/Tait_equation
  * $B = V_s^2 / \rho_0\gamma$ ~ 1.1

* Artificial equation of state WCSPH
  *  2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# Artificial Viscosity Term
* 2014 (Markus et al) SPH Fluids in Computer Graphics 식이 잘못되어 있음
* 2005 (monaghan) Smoothed Particle Hydrodynamics
* 2022 (Dan et al) A Survey on SPH Methods in Computer Graphics

# Surface Tension
* 2000 (Joseph) Simulating surface tension with SPH


# Density Flucutation
* 0.01 rho0
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows
  * density fluctuation ~ M^2, M= 0.1, 
* 

# Presssure Constant
* 1119kPa ~ 10^6
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows

# 상수정리
```
  Material_Property mat_prop;
  mat_prop.rest_density         = 1.0e3f;
  mat_prop.pressure_coefficient = 2.5e5f;
  mat_prop.viscosity            = 1.0e-2f;

  Initial_Condition_Cube init_cond;
  init_cond.init_pos             = {-1.0f, -1.0f, 0.0f};
  init_cond.edge_length          = 1.0f;
  init_cond.num_particle_in_edge = 20;
```
 

# Kernels
* https://pysph.readthedocs.io/en/latest/reference/kernels.html
* https://www.cs.cornell.edu/~bindel/class/cs5220-f11/code/sph.pdf

# Neighborhood Search
## Uniform Grid
**자신이 속한 grid cell을 찾는다.**

grid cell마다 고유의 grid cell index vector $c$를 갖는다.

$$ c = (i,j,k) $$

임의의 particle의 위치를 $x$라고 할 때, $x$가 속한 grid cell의 $c$는 다음과 같다.

$$ c(x) = (\left\lceil \frac{x-x_{min}}{h}  \right\rceil, \left\lceil \frac{y-y_{min}}{h}  \right\rceil, \left\lceil \frac{z-z_{min}}{h}  \right\rceil $$

이 떄, $h$는 정육면체의 길이, $(x_{min},y_{min},z_{min})$는 bounding box의 최소 좌표이다.

정육면체의 한 면을 $h$라고 할 때, $h$가 smoothing length와 같다고 가정하자.

Domain bounding box에 속한 모든 $c$의 집합을 $C$, $x$가 속한 grid cell의 index vector를 $c_x = (i_x,j_x,k_x)$라고 한다면 집합 $N$은 다음과 같다.

$$ N = \{ (i,j,k) | (i_x \pm 1,j_x \pm 1, k_x \pm 1) \in C \} $$

즉, 최대 27개의 grid cell만 탐색하면 된다. 


Domain bounding box가 $x,y,z$ 방향으로 $N_{x,y,z}$개로 나뉘었다고 하자.

그러면 $c$의 고유의 index $c_i$를 다음과 같이 구할 수 있다.

$$ c_i = i + j  N_x + k N_x N_y $$

따라서, grid cell마다 속한 particle을 저장하기 위해서 이중배열이면 충분하다.

## Index Sort
unifrom grid는 동시에 같은 memory에 접근하는 race condition으로 parallel construction이 어렵다.

memory conflict를 피하기 위해 먼저 particle을 cell index로 sorting한다.

## Spatial Hashing



# Pressure Computation
* Equation of State(EOS)

# Time Integration


# 테스트
20 * 20 * 20 -> 300FPS
20 * 20 * 20 -> 400FPS (heap allocation 줄이기)
20 * 20 * 20 -> 600FPS (update에서 한번에 처리하기)

10 * 10 * 10 -> 370FPS (기본)
10 * 10 * 10 -> 450FPS (heap allocation 줄이기)
10 * 10 * 10 -> 600FPS (update에서 한번에 처리하기)



