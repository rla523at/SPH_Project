# SPH Frame Work
SPH approximation에 의해 임의의 물리량 $f$에 대한 근사식은 다음과 같다.

$$ f(x) = \sum_j \frac{m_j}{\rho_j}f(x_j) W(x-x_j,h) $$

이 approximation을 통해 비압축성 유체의 linear momentum equation을 푼다.

$$ \frac{du}{dt} = -\frac{1}{\rho}\nabla p + \nu \nabla^2u + f_{ext} $$

전체적인 solution prcess는 다음과 같다.

1. SPH approximation을 통해 $\rho$를 계산한다.
2. 계산된 $\rho$를 통해 $p$를 계산한다.
3. SPH approximation를 활용해 linear momentum equation의 RHS를 계산한다.
4. 계산된 가속도로 속도를 업데이트하고, 속도로 위치를 업데이트한다.

</br></br>

# SPH Approximation
## Integral Representation
임의의 $f:\mathbb{R}^3\rightarrow \mathbb{R}$가 있을 떄, 임의의 $x \in \Omega \subseteq \mathbb{R}^3$에 대해서 다음이 성립한다.

$$ f(x) = \int_{\Omega} f(t)\delta(x-t)dt $$

$\delta$는 dirac-delta function kernel이다.

## Approximation of Integral Representation
$\delta$를 임의의 smooth kernel function $W(x,h):\mathbb{R}^3 \rightarrow \mathbb{R}$로 근사하면 다음과 같다.

$$ f(x) \approx \int_{\Omega} f(t)W(x-t, h)dt $$

이처럼, $\delta$를 임의의 smooth function으로 approximation을 하기 때문에 'smoothed' particle hydronamics라고 한다.

## Particle Approximation
$W$를 이용한 Integral Representation의 approximation은 discretized form으로 한번 더 근사가 될 수 있다.

$$ \begin{aligned} 
f(x) &\approx \int_{\Omega} f(t)W(x-t, h)dt \\ 
     &\approx \sum_{j} f(x_j)W(x-x_j,h) \Delta V_j \\ 
     & = \sum_{j} f(x_j)W(x-x_j,h) \frac{\rho_j \Delta V_j}{\rho_j} \\ 
     &= \sum_{j} f(x_j)W(x-x_j,h) \frac{m_j}{\rho_j} 
\end{aligned}  $$

따라서, SPH frame work상 임의의 물리량 $f$에 대한 최종 근사식은 다음과 같다.

$$ f(x) = \sum_j \frac{m_j}{\rho_j}f(x_j) W(x-x_j,h) $$

</br></br>

# Smooth Kernel Function
$W(x,h)$는 $\delta$를 근사한 함수이기 때문에 다음 세가지 조건을 만족해야한다.

Normalization condition

$$ \int_\Omega W(x-t,h)dt = 1$$

Delta Function Property

$$ \lim_{h\rightarrow 0} W(x-t,h) = \delta(x-t)$$

Compact Supprot Property

$$ \kappa h < |x-t| \implies W(x-t,h) = 0 $$

따라서, $h$에 의해 $W$의 compact support domain이 결정되며, $h$를 support length라고 한다.

![support length](https://github.com/user-attachments/assets/788aa774-2b4f-4b4c-a260-6a9b29e40c33)

</br></br>

# Density Calculation
SPH 근사식에 밀도를 대입하면 다음과 같다.

$$ \rho(x) = \sum_j m_jW(x,x_j,h) $$

비압축성 유체이기 때문에 $m_j$가 일정하다고 가정하면 밀도는 오직 거리의 함수이다. 

밀도는 pressure calculation과 비압축성 가정 $(\frac{\Delta\rho}{\rho_0})^2 \sim (M \le 0.1)$에 의해 다음 범위의 값을 갖는것이 타당하다.

$$ \rho_0 \le \rho \le 1.01 \rho_0 $$

밀도 값에 영향을 주는 값들은 $m$ 그리고 $W$ 값이다.

이 때, $W$의 값은 $h$를 어떻게 결정하냐에 따라 크게 달라진다.

## smoothing length
3차원 기준 neighbor가 50개가 되도록 잡는게 좋다.

> Reference  
> https://scicomp.stackexchange.com/questions/16363/how-to-choose-h-in-sph  

</br></br>

# Pressure Calculation
압력은 Equation of state에 기반하여 수정한 다음 식을 사용한다.

$$ p = k ((\frac{\rho}{\rho_0})^7 - 1) $$

$\rho_0$는 rest density로 유체가 기본 상태에 있을 때의 밀도를 나타낸다.

$k$는 stiffness constant로 큰 값을 쓸 수록, compressibility는 줄어들지만 (밀도 변화는 줄어들지만) time step 또한 줄어든다.

참고로, 위 식에서 $\rho < \rho_0$인 경우 $p<0$가 된다. 압력이 음수가 되는 것은 비물리적임으로 밀도가 $\rho_0$ 항상 커야 한다.

</br></br>

# Acceleration by Pressure

$$ a_p(x_i) = - \frac{1}{\rho} \sum_j m_j(\frac{p_a}{\rho_a^2} + \frac{p_b}{\rho_b^2}) \nabla_iW_{ij} $$

$a_p$의 방향은 $-\nabla_iW_{ij}$이다.

</br></br>

---

* SPH Water simulation 
  * https://www.youtube.com/watch?v=uaoT37-NhCE


* Weakly Compressible SPH (WCSPH)
  * local pressure solvers
* Incompressible SPH (ISPH)
  * global pressure solvers


# Smoothing Length
* $h=1.3 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 1999 (Sharen and Rudman) An SPH Projection Method

* $h = 1 - 1.5 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2000 (Joseph) Simulating surface tension with SPH
  * 

* $h = \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows

* $h = 1.6 \Delta x$
  * $\Delta x$ = initial particle spacing
  * 2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# mass
* normalized mass
  * [note] 2011 (cornell)  

* density * particle volume
  * 1994 (monaghan) Simulating Free Surface Flows with SPH - 5. Implementation

* number density
  * 2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# Kernel Function
* cubic spline 
* 2014 (Markus et al) SPH Fluids in Computer Graphics
* 2010 (Liu and Liu) SPH an overview and recent developments
* gradient, dwdq
  * https://pysph.readthedocs.io/en/latest/_modules/pysph/base/kernels.html#CubicSpline.gradient_h

# Density Calculation
* evolve particel density
  * 1994 (monaghan) Simulating Free Surface Flows with SPH
  * 

* Free Surface Boundaries
  * 2012 (Xiaowei et al) Local Poisson SPH For Viscous Incompressible Fluids


# Pressure Calculation
* Tait's equation
  * $B = \rho_0 V_s^2 / \gamma$ ~ 1.1e06 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows
    * 2012 (Xiaowei et al) Local Poisson SPH For Viscous Incompressible Fluids
  * K = 2.15GPa https://en.wikipedia.org/wiki/Tait_equation
  * $B = V_s^2 / \rho_0\gamma$ ~ 1.1

* Artificial equation of state WCSPH
  *  2012 (Mostafa et al) A robust weakly compressible SPH method and its comparison with an incompressible SPH

# Artificial Viscosity Term
* 2014 (Markus et al) SPH Fluids in Computer Graphics 식이 잘못되어 있음
* 2005 (monaghan) Smoothed Particle Hydrodynamics
* 2022 (Dan et al) A Survey on SPH Methods in Computer Graphics

# Surface Tension
* 2000 (Joseph) Simulating surface tension with SPH


# Density Flucutation
* 0.01 rho0
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows
  * density fluctuation ~ M^2, M= 0.1, 
* 

# Presssure Constant
* 1119kPa ~ 10^6
  * 2007 (Markus and Matthias) Weakly compressible SPH for free surface flows

# 상수정리
```
  Material_Property mat_prop;
  mat_prop.rest_density         = 1.0e3f;
  mat_prop.pressure_coefficient = 2.5e5f;
  mat_prop.viscosity            = 1.0e-2f;

  Initial_Condition_Cube init_cond;
  init_cond.init_pos             = {-1.0f, -1.0f, 0.0f};
  init_cond.edge_length          = 1.0f;
  init_cond.num_particle_in_edge = 20;
```
 

# Kernels
* https://pysph.readthedocs.io/en/latest/reference/kernels.html
* https://www.cs.cornell.edu/~bindel/class/cs5220-f11/code/sph.pdf

# Neighborhood Search
## Uniform Grid
**자신이 속한 grid cell을 찾는다.**

grid cell마다 고유의 grid cell index vector $c$를 갖는다.

$$ c = (i,j,k) $$

임의의 particle의 위치를 $x$라고 할 때, $x$가 속한 grid cell의 $c$는 다음과 같다.

$$ c(x) = (\left\lceil \frac{x-x_{min}}{h}  \right\rceil, \left\lceil \frac{y-y_{min}}{h}  \right\rceil, \left\lceil \frac{z-z_{min}}{h}  \right\rceil $$

이 떄, $h$는 정육면체의 길이, $(x_{min},y_{min},z_{min})$는 bounding box의 최소 좌표이다.

정육면체의 한 면을 $h$라고 할 때, $h$가 smoothing length와 같다고 가정하자.

Domain bounding box에 속한 모든 $c$의 집합을 $C$, $x$가 속한 grid cell의 index vector를 $c_x = (i_x,j_x,k_x)$라고 한다면 집합 $N$은 다음과 같다.

$$ N = \{ (i,j,k) | (i_x \pm 1,j_x \pm 1, k_x \pm 1) \in C \} $$

즉, 최대 27개의 grid cell만 탐색하면 된다. 


Domain bounding box가 $x,y,z$ 방향으로 $N_{x,y,z}$개로 나뉘었다고 하자.

그러면 $c$의 고유의 index $c_i$를 다음과 같이 구할 수 있다.

$$ c_i = i + j  N_x + k N_x N_y $$

따라서, grid cell마다 속한 particle을 저장하기 위해서 이중배열이면 충분하다.

## Index Sort
unifrom grid는 동시에 같은 memory에 접근하는 race condition으로 parallel construction이 어렵다.

memory conflict를 피하기 위해 먼저 particle을 cell index로 sorting한다.

## Spatial Hashing



# Pressure Computation
* Equation of State(EOS)

# Time Integration


# 테스트
20 * 20 * 20 -> 300FPS
20 * 20 * 20 -> 400FPS (heap allocation 줄이기)
20 * 20 * 20 -> 600FPS (update에서 한번에 처리하기)

10 * 10 * 10 -> 370FPS (기본)
10 * 10 * 10 -> 450FPS (heap allocation 줄이기)
10 * 10 * 10 -> 600FPS (update에서 한번에 처리하기)



